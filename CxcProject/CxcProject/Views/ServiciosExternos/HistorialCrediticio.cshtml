@using System.Xml.Linq
@{
    ViewData["Title"] = "Historial Crediticio";

    var xmlString = (string)ViewBag.Historial ?? "";
    XElement xml = null;

    try
    {
        xml = XElement.Parse(xmlString);
    }
    catch
    {
        xml = null;
    }

    List<dynamic> historialList = new();

    if (xml != null)
    {
        XNamespace s = "http://schemas.xmlsoap.org/soap/envelope/";
        XNamespace ns = "http://tempuri.org/";

        var resultados = xml.Element(s + "Body")?
                           .Element(ns + "ConsultarHistorialResponse")?
                           .Element(ns + "ConsultarHistorialResult")?
                           .Elements(ns + "HistorialCrediticioResponse");

        if (resultados != null)
        {
            foreach (var item in resultados)
            {
                historialList.Add(new
                {
                    Id = (string)item.Element(ns + "Id") ?? "",
                    RncEmpresa = (string)item.Element(ns + "RncEmpresa") ?? "",
                    ConceptoDeuda = (string)item.Element(ns + "ConceptoDeuda") ?? "",
                    Fecha = (string)item.Element(ns + "Fecha") ?? "",
                    MontoAdeudado = (string)item.Element(ns + "MontoAdeudado") ?? "",
                    ClienteCedulaRnc = (string)item.Element(ns + "ClienteCedulaRnc") ?? ""
                });
            }
        }
    }
}
<div class="container mt-4">
    <h2 class="text-dark mb-4">📜 Historial Crediticio</h2>

    @if (xml == null)
    {
            <div class="alert alert-danger">No se pudo procesar la información recibida.</div>
    }
    else if (!historialList.Any())
    {
            <div class="alert alert-info">No se encontraron registros de historial crediticio.</div>
    }
    else
    {
            <div class="card shadow-sm">
                <div class="card-body table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Empresa (RNC)</th>
                                <th>Concepto de Deuda</th>
                                <th>Fecha</th>
                                <th>Monto Adeudado</th>
                                <th>Cédula / RNC Cliente</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var item in historialList)
                        {
                            DateTime dt;
                           <tr>
                               <td>@item.Id</td>
                               <td>@item.RncEmpresa</td>
                               <td>@item.ConceptoDeuda</td>
                               <td>@(DateTime.TryParse(item.Fecha, out dt) ? dt.ToString("dd/MM/yyyy") : item.Fecha)</td>
                               <td>@item.MontoAdeudado</td>
                               <td>@item.ClienteCedulaRnc</td>
                          </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
    }

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">⬅ Volver</a>
    </div>
</div>